<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SLi Project</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style is:global>
        /* CSS ini akan dipaksa ke semua pesan agar ukurannya normal */
        .chat-body .msg { 
            padding: 12px 16px !important; 
            border-radius: 18px !important; 
            font-size: 14px !important; /* Mengunci ukuran font agar tidak membesar */
            line-height: 1.4 !important; 
            max-width: 80% !important; 
            word-wrap: break-word !important;
            margin-bottom: 10px !important;
            display: block !important;
            clear: both !important;
        }

        /* Pesan User: Biru */
        .chat-body .msg.user { 
            background-color: #0284c7 !important; 
            color: white !important; 
            float: right !important;
            border-bottom-right-radius: 4px !important; 
        }

        /* Pesan Bot: Abu-abu (Sama dengan sapaan awal) */
        .chat-body .msg.bot { 
            background-color: #e2e8f0 !important; 
            color: #1e293b !important; 
            float: left !important;
            border-bottom-left-radius: 4px !important; 
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <button id="chat-trigger" class="chat-btn">Chat AI</button>
        <div id="chat-window" class="chat-window">
            <div class="chat-header">
                <strong>SLi Chatbot AI</strong>
                <button id="close-chat" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <div id="chat-messages" class="chat-body">
                <div class="msg bot">Halo! Saya asisten AI SLi Project. Ada yang bisa saya bantu?</div>
            </div>
            <form id="chat-form" class="chat-footer">
                <input type="text" id="user-input" placeholder="Ketik pesan..." required autocomplete="off" />
                <button type="submit">âž¤</button>
            </form>
        </div>
    </div>

    <script is:inline>
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatTrigger = document.getElementById('chat-trigger');
        const chatWindow = document.getElementById('chat-window');
        const closeChat = document.getElementById('close-chat');

        const sessionId = "sess_" + Math.random().toString(36).substring(7);

        chatTrigger.onclick = () => chatWindow.classList.toggle('show');
        closeChat.onclick = () => chatWindow.classList.remove('show');

        function addMessage(text, sender) {
            const div = document.createElement('div');
            
            // TRIK RAHASIA: Ambil atribut 'data-astro' dari pesan bot pertama
            const firstBotMsg = chatMessages.querySelector('.msg.bot');
            if (firstBotMsg) {
                // Cari atribut yang namanya diawali 'data-astro-cid'
                const astroAttr = Array.from(firstBotMsg.attributes).find(attr => attr.name.startsWith('data-astro-cid'));
                if (astroAttr) {
                    div.setAttribute(astroAttr.name, astroAttr.value);
                }
            }

            div.className = `msg ${sender}`;
            div.textContent = text;
            chatMessages.appendChild(div);

            const spacer = document.createElement('div');
            spacer.style.clear = 'both';
            chatMessages.appendChild(spacer);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if(!text) return;

            addMessage(text, 'user');
            userInput.value = '';

            try {
                const response = await fetch('https://n8n.aleshatour.my.id/webhook/website', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: text, chatId: sessionId })
                });
                const data = await response.json();
                addMessage(data.reply || data.output || "Maaf, tim kami akan segera membalas!", 'bot');
            } catch (err) {
                addMessage("Koneksi bermasalah.", 'bot');
            }
        };
    </script>
</body>
</html>